name: Release to PyPI

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+(a[0-9]+|b[0-9]+|rc[0-9]+)?'  # Matches 1.2.3, 1.2.3a1, 1.2.3b1, 1.2.3rc1

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.version }}
      is_prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Get tag version
        id: tag
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Get package version
        id: package
        run: |
          # Extract version from __init__.py
          VERSION=$(python -c "
          import re
          with open('src/pabot/__init__.py', 'r') as f:
              content = f.read()
              match = re.search(r'__version__\s*=\s*[\"\'](.*?)[\"\']', content)
              if match:
                  print(match.group(1))
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Verify versions match
        run: |
          echo "Tag version: ${{ steps.tag.outputs.version }}"
          echo "Package version: ${{ steps.package.outputs.version }}"
          if [ "${{ steps.tag.outputs.version }}" != "${{ steps.package.outputs.version }}" ]; then
            echo "Error: Tag version does not match package version!"
            echo "Tag: ${{ steps.tag.outputs.version }}"
            echo "Package: ${{ steps.package.outputs.version }}"
            exit 1
          fi
          echo "âœ“ Versions match!"

      - name: Detect prerelease tag
        id: prerelease
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          if [[ "$VERSION" =~ (a[0-9]+|b[0-9]+|rc[0-9]+)$ ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Detected prerelease: true"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Detected prerelease: false"
          fi
      
  run-tests:
    needs: validate-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: ["3.8", "3.10", "3.12", "3.14"]
        robotframework:
          - "4.1.3"
          - "5.0.1"
          - "6.0.2"
          - "6.1.1"
          # - "7.0.1"  # Tested by ci.yml
          - "7.1.1"
          # - "7.2.2"  # Tested by ci.yml
          - "7.3.2"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      
      - name: Install Dependencies
        run: |
          pip install pytest
          pip install -r ./requirements.txt
          pip install "robotframework~=${{ matrix.robotframework }}"
          pip install -e .
      
      - name: Run Pytest
        run: pytest tests
  
  build-and-release:
    needs: [validate-version, run-tests]
    runs-on: ubuntu-latest
    environment: release  # Optional: for manual approval
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install build tools
        run: |
          pip install --upgrade pip build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload dist/*.*
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Pabot ${{ needs.validate-version.outputs.version }}
          body: |
            ## Pabot ${{ needs.validate-version.outputs.version }}
            
            Released to PyPI: https://pypi.org/project/robotframework-pabot/${{ needs.validate-version.outputs.version }}/
            
            ### Installation
            ```bash
            pip install robotframework-pabot==${{ needs.validate-version.outputs.version }}
            ```
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: ${{ needs.validate-version.outputs.is_prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}